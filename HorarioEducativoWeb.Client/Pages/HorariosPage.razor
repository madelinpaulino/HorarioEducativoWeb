@page "/horarios"
@inject HttpClient Http
@using System.Net.Http.Json
@using HorarioEducativoWeb.API.Models

<PageTitle>Gestión de Horarios</PageTitle>

<div class="container mt-4">
    <h3>Gestión de Horarios</h3>

    @* --- FORMULARIO PARA AÑADIR / EDITAR --- *@
    <div class="card mb-4 shadow-sm">
        <div class="card-header @(esEdicion ? "bg-warning text-dark" : "bg-primary text-white")">
            <i class="bi @(esEdicion ? "bi-pencil-square" : "bi-plus-circle")"></i>
            @(esEdicion ? "Editar Horario" : "Añadir Nuevo Horario")
        </div>
        <div class="card-body">
            <EditForm Model="@modelo" OnValidSubmit="Guardar">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Día</label>
                        <select class="form-select" @bind="modelo.DiaSemana">
                            <option value="">Seleccione...</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Docente</label>
                        <select class="form-select" @bind="modelo.DocenteId">
                            <option value="0">Seleccione Docente...</option>
                            @foreach (var d in docentes)
                            {
                                <option value="@d.Id">@d.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Asignatura</label>
                        <select class="form-select" @bind="modelo.AsignaturaId">
                            <option value="0">Seleccione Asignatura...</option>
                            @foreach (var a in asignaturas)
                            {
                                <option value="@a.Id">@a.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Aula</label>
                        <select class="form-select" @bind="modelo.AulaId">
                            <option value="0">Seleccione Aula...</option>
                            @foreach (var au in aulas)
                            {
                                <option value="@au.Id">@au.Codigo</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hora Inicio</label>
                        @* El bind se hace a las propiedades auxiliares *@
                        <input type="time" class="form-control" @bind="horaInicioForm" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hora Fin</label>
                        <input type="time" class="form-control" @bind="horaFinForm" />
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="bi bi-save"></i> @(esEdicion ? "Actualizar" : "Guardar")
                        </button>
                        @if (esEdicion)
                        {
                            <button type="button" class="btn btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
                        }
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    @* --- TABLA DE HORARIOS --- *@
    @if (listaHorarios == null)
    {
        <div class="text-center"><div class="spinner-border text-primary"></div><p>Cargando...</p></div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover border shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Día</th>
                        <th>Hora</th>
                        <th>Asignatura</th>
                        <th>Docente</th>
                        <th>Aula</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in listaHorarios)
                    {
                        <tr>
                            <td><span class="badge bg-info text-dark">@h.DiaSemana</span></td>
                            <td>@h.HoraInicio.ToString(@"hh\:mm") - @h.HoraFin.ToString(@"hh\:mm")</td>
                            <td>@h.Asignatura?.Nombre</td>
                            <td>@h.Docente?.Nombre</td>
                            <td>@h.Aula?.Codigo</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" @onclick="() => PrepararEditar(h)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => Eliminar(h.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Horario>? listaHorarios;
    private List<Docente> docentes = new();
    private List<Asignatura> asignaturas = new();
    private List<Aula> aulas = new();

    private Horario modelo = new() { GrupoId = 1 };
    private bool esEdicion = false;

    // CORRECCIÓN: Propiedades con lógica explícita para evitar errores de conversión
    private TimeOnly? horaInicioForm
    {
        get => TimeOnly.FromTimeSpan(modelo.HoraInicio);
        set => modelo.HoraInicio = value?.ToTimeSpan() ?? TimeSpan.Zero;
    }

    private TimeOnly? horaFinForm
    {
        get => TimeOnly.FromTimeSpan(modelo.HoraFin);
        set => modelo.HoraFin = value?.ToTimeSpan() ?? TimeSpan.Zero;
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            listaHorarios = await Http.GetFromJsonAsync<List<Horario>>("api/Schedule");
            docentes = await Http.GetFromJsonAsync<List<Docente>>("api/Docentes") ?? new();
            asignaturas = await Http.GetFromJsonAsync<List<Asignatura>>("api/Asignaturas") ?? new();
            aulas = await Http.GetFromJsonAsync<List<Aula>>("api/Aulas") ?? new();
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"Error al cargar datos: {ex.Message}"); 
        }
    }

    private async Task Guardar()
    {
        try
        {
            if (esEdicion)
                await Http.PutAsJsonAsync($"api/Schedule/{modelo.Id}", modelo);
            else
                await Http.PostAsJsonAsync("api/Schedule", modelo);

            await CancelarEdicion();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar: {ex.Message}");
        }
    }

    private void PrepararEditar(Horario h)
    {
        modelo = new Horario {
            Id = h.Id,
            DiaSemana = h.DiaSemana,
            DocenteId = h.DocenteId,
            AsignaturaId = h.AsignaturaId,
            AulaId = h.AulaId,
            GrupoId = h.GrupoId,
            HoraInicio = h.HoraInicio,
            HoraFin = h.HoraFin
        };
        esEdicion = true;
    }

    private async Task Eliminar(int id)
    {
        var respuesta = await Http.DeleteAsync($"api/Schedule/{id}");
        if (respuesta.IsSuccessStatusCode)
        {
            await CargarDatos();
        }
    }

    private async Task CancelarEdicion()
    {
        modelo = new Horario() { GrupoId = 1 };
        esEdicion = false;
        await CargarDatos();
    }
}