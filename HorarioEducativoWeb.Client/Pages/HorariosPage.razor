@page "/horarios"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Net.Http.Json
@using HorarioEducativoWeb.Shared.Models

@* Título dinámico en la pestaña del navegador *@
<PageTitle>Horarios - @centro.Nombre</PageTitle>

<div class="container mt-4">
    @* --- ENCABEZADO CON NOMBRE DEL CENTRO --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0"><i class="bi bi-calendar3"></i> Gestión de Horarios</h3>
            <small class="text-muted fw-bold">@centro.Nombre</small>
        </div>
        <button class="btn btn-outline-primary shadow-sm" @onclick="CargarDatos">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
    </div>

    @* --- FORMULARIO --- *@
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header @(esEdicion ? "bg-warning text-dark" : "bg-primary text-white") py-3">
            <h5 class="mb-0">
                <i class="bi @(esEdicion ? "bi-pencil-square" : "bi-plus-circle") me-2"></i>
                @(esEdicion ? "Editar Horario" : "Añadir Nuevo Horario")
            </h5>
        </div>
        <div class="card-body bg-light">
            <EditForm Model="@modelo" OnValidSubmit="Guardar">
                <div class="row g-3">
                    @* Selector de Día *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Día</label>
                        <select class="form-select" @bind="modelo.DiaSemana" required>
                            <option value="">Seleccione...</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                        </select>
                    </div>
                    
                    @* Selector de Grupos *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Grupo / Grado</label>
                        <select class="form-select" @bind="modelo.GrupoId" required>
                            <option value="0" disabled>Seleccione Grupo...</option>
                            @foreach (var g in grupos)
                            {
                                <option value="@g.Id">@g.Nombre (@g.Modalidad)</option>
                            }
                        </select>
                    </div>

                    @* Selector de Docente *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Docente</label>
                        <select class="form-select" @bind="modelo.DocenteId" required>
                            <option value="0" disabled>Seleccione Docente...</option>
                            @foreach (var d in docentes)
                            {
                                <option value="@d.Id">@d.Nombre</option>
                            }
                        </select>
                    </div>

                    @* Selector de Asignatura *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Asignatura</label>
                        <select class="form-select" @bind="modelo.AsignaturaId" required>
                            <option value="0" disabled>Seleccione Asignatura...</option>
                            @foreach (var a in asignaturas)
                            {
                                <option value="@a.Id">@a.Nombre</option>
                            }
                        </select>
                    </div>

                    @* Selector de Aula *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Aula</label>
                        <select class="form-select" @bind="modelo.AulaId" required>
                            <option value="0" disabled>Seleccione Aula...</option>
                            @foreach (var au in aulas)
                            {
                                <option value="@au.Id">@au.Codigo</option>
                            }
                        </select>
                    </div>

                    @* Horas *@
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Hora Inicio</label>
                        <input type="time" class="form-control" @bind="horaInicioForm" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Hora Fin</label>
                        <input type="time" class="form-control" @bind="horaFinForm" required />
                    </div>

                    @* Botones *@
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn @(esEdicion ? "btn-warning" : "btn-success") w-100 shadow-sm">
                            <i class="bi bi-save"></i> @(esEdicion ? "Actualizar" : "Guardar")
                        </button>
                        @if (esEdicion)
                        {
                            <button type="button" class="btn btn-secondary shadow-sm" @onclick="CancelarEdicion">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    @* --- TABLA --- *@
    @if (listaHorarios == null)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Sincronizando con el servidor...</p>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle bg-white border">
                <thead class="table-dark">
                    <tr>
                        <th>Día</th>
                        <th>Grupo</th>
                        <th>Horario</th>
                        <th>Asignatura</th>
                        <th>Docente</th>
                        <th>Aula</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in listaHorarios)
                    {
                        <tr>
                            <td><span class="badge rounded-pill bg-info text-dark">@h.DiaSemana</span></td>
                            <td><span class="fw-bold text-primary">@h.Grupo?.Nombre</span></td>
                            <td>
                                <i class="bi bi-clock me-1 text-muted"></i>
                                @h.HoraInicio.ToString(@"hh\:mm") - @h.HoraFin.ToString(@"hh\:mm")
                            </td>
                            <td>@h.Asignatura?.Nombre</td>
                            <td>@h.Docente?.Nombre</td>
                            <td><span class="badge bg-light text-dark border">@h.Aula?.Codigo</span></td>
                            <td class="text-center">
                                <button class="btn btn-outline-warning btn-sm me-1" @onclick="() => PrepararEditar(h)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => Eliminar(h.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Horario>? listaHorarios;
    private List<Docente> docentes = new();
    private List<Asignatura> asignaturas = new();
    private List<Aula> aulas = new();
    private List<Grupo> grupos = new();
    private CentroEducativo centro = new() { Nombre = "Cargando..." };

    private Horario modelo = new() { GrupoId = 0, DocenteId = 0, AsignaturaId = 0, AulaId = 0 };
    private bool esEdicion = false;

    private TimeOnly? horaInicioForm {
        get => TimeOnly.FromTimeSpan(modelo.HoraInicio);
        set => modelo.HoraInicio = value?.ToTimeSpan() ?? TimeSpan.Zero;
    }

    private TimeOnly? horaFinForm {
        get => TimeOnly.FromTimeSpan(modelo.HoraFin);
        set => modelo.HoraFin = value?.ToTimeSpan() ?? TimeSpan.Zero;
    }

    protected override async Task OnInitializedAsync() => await CargarDatos();

    private async Task CargarDatos() {
        try {
            // Se añade la carga del nombre del centro
            centro = await Http.GetFromJsonAsync<CentroEducativo>("api/Centro") ?? new();
            
            listaHorarios = await Http.GetFromJsonAsync<List<Horario>>("api/Schedule");
            docentes = await Http.GetFromJsonAsync<List<Docente>>("api/Docentes") ?? new();
            asignaturas = await Http.GetFromJsonAsync<List<Asignatura>>("api/Asignaturas") ?? new();
            aulas = await Http.GetFromJsonAsync<List<Aula>>("api/Aulas") ?? new();
            grupos = await Http.GetFromJsonAsync<List<Grupo>>("api/Grupos") ?? new();
        } catch (Exception ex) {
            Console.WriteLine($"Error de carga: {ex.Message}");
        }
    }

    private async Task Guardar() {
        if (modelo.GrupoId == 0 || modelo.DocenteId == 0 || modelo.AsignaturaId == 0 || modelo.AulaId == 0 || string.IsNullOrEmpty(modelo.DiaSemana)) {
            await JS.InvokeVoidAsync("Swal.fire", "Campos incompletos", "Por favor, seleccione todos los campos requeridos.", "warning");
            return;
        }

        if (modelo.HoraFin <= modelo.HoraInicio) {
            await JS.InvokeVoidAsync("Swal.fire", "Error de Horario", "La hora de finalización debe ser posterior a la de inicio.", "error");
            return;
        }

        try {
            HttpResponseMessage res = esEdicion 
                ? await Http.PutAsJsonAsync($"api/Schedule/{modelo.Id}", modelo)
                : await Http.PostAsJsonAsync("api/Schedule", modelo);

            if (res.IsSuccessStatusCode) {
                await CargarDatos();
                CancelarEdicion();
                await JS.InvokeVoidAsync("Swal.fire", "¡Guardado!", "El horario se registró correctamente.", "success");
            } else {
                var errorMsg = await res.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("Swal.fire", "Conflicto Detectado", errorMsg, "warning");
            }
        } catch (Exception ex) {
            await JS.InvokeVoidAsync("Swal.fire", "Error", "Ocurrió un error al procesar la solicitud.", "error");
            Console.WriteLine(ex.Message);
        }
    }

    private void PrepararEditar(Horario h) {
        modelo = new Horario {
            Id = h.Id,
            DiaSemana = h.DiaSemana,
            DocenteId = h.DocenteId,
            AsignaturaId = h.AsignaturaId,
            AulaId = h.AulaId,
            GrupoId = h.GrupoId,
            HoraInicio = h.HoraInicio,
            HoraFin = h.HoraFin
        };
        esEdicion = true;
    }

    private async Task Eliminar(int id) {
        bool confirmar = await JS.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este bloque de horario?");
        if (confirmar) {
            var res = await Http.DeleteAsync($"api/Schedule/{id}");
            if (res.IsSuccessStatusCode) {
                await CargarDatos();
                await JS.InvokeVoidAsync("Swal.fire", "Eliminado", "Registro borrado.", "success");
            }
        }
    }

    private void CancelarEdicion() {
        modelo = new Horario { 
            GrupoId = 0, 
            DocenteId = 0, 
            AsignaturaId = 0, 
            AulaId = 0,
            DiaSemana = ""
        };
        esEdicion = false;
    }
}