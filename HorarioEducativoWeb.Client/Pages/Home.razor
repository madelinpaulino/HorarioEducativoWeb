@page "/"
@using HorarioEducativoWeb.Shared.Models
@inject HttpClient Http

<PageTitle>Inicio - @centro.Nombre</PageTitle>

<div class="container mt-4">
    @if (estaCargando)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
            <div class="spinner-border text-primary" role="status"></div>
            <span class="ms-3 text-muted">Cargando panel de control...</span>
        </div>
    }
    else
    {
        @* --- HERO SECTION CON DATOS DEL CENTRO --- *@
        <div class="p-5 mb-4 bg-primary text-white rounded-3 shadow border-0 position-relative overflow-hidden">
            <div class="container-fluid py-5 position-relative" style="z-index: 2;">
                <h1 class="display-5 fw-bold">@centro.Nombre</h1>
                <p class="col-md-8 fs-4 opacity-75">
                    RNC: @centro.RNC | @centro.Direccion
                </p>
                <hr class="my-4 border-light opacity-25">
                <div class="d-flex gap-3">
                    <a href="horarios" class="btn btn-light btn-lg px-4 fw-bold text-primary">
                        <i class="bi bi-calendar3 me-2"></i> Ver Horario Semanal
                    </a>
                    <a href="configuracion" class="btn btn-outline-light btn-lg px-4">
                        <i class="bi bi-gear me-2"></i> Configuración
                    </a>
                </div>
            </div>
            @* Decoración abstracta de fondo *@
            <div class="position-absolute end-0 bottom-0 opacity-25" style="transform: translate(10%, 10%);">
                <i class="bi bi-journal-check" style="font-size: 15rem;"></i>
            </div>
        </div>

        @* --- DASHBOARD DE ESTADÍSTICAS --- *@
        <div class="row g-4 mb-4">
            @* Card Docentes *@
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-white h-100 py-2 border-start border-primary border-5">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Docentes</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">@totalDocentes</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-person-badge fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @* Card Asignaturas *@
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-white h-100 py-2 border-start border-success border-5">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Asignaturas</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">@totalAsignaturas</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-book fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @* Card Aulas *@
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-white h-100 py-2 border-start border-info border-5">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Aulas</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">@totalAulas</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-door-open fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @* Card Horarios *@
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-white h-100 py-2 border-start border-warning border-5">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Bloques</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">@totalHorarios</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-clock-history fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* --- ACCESO DIRECTO A SECCIONES --- *@
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 font-weight-bold text-primary fw-bold">Próximos Pasos Recomendados</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <a href="configuracion" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-plus-circle-fill text-success me-2"></i>
                                    Registrar nuevos profesores para el ciclo actual.
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </a>
                            <a href="horarios" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                                    Revisar conflictos de aula en el turno vespertino.
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                 <div class="card shadow-sm border-0 bg-light">
                    <div class="card-body text-center py-4">
                        <i class="bi bi-shield-check text-primary" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 fw-bold">Sistema Seguro</h5>
                        <p class="small text-muted">Sincronizado con la base de datos de <strong>@centro.Nombre</strong>.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-2 p-2 bg-dark text-white-50 rounded-pill d-inline-block px-4 mb-4" style="font-size: 0.8rem;">
            <span class="spinner-grow spinner-grow-sm text-success me-2"></span> 
            API Conectada: v1.0 | .NET 8.0 
        </div>
    }
</div>

@code {
    private CentroEducativo centro = new() { Nombre = "Cargando Centro...", Direccion = "...", RNC = "..." };
    private int totalDocentes;
    private int totalAsignaturas;
    private int totalAulas;
    private int totalHorarios;
    private bool estaCargando = true;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // 1. CARGAMOS LA INFORMACIÓN DEL CENTRO (OBLIGATORIO)
            var centroData = await Http.GetFromJsonAsync<CentroEducativo>("api/Centro");
            if (centroData != null) centro = centroData;

            // 2. CARGAMOS ESTADÍSTICAS EN PARALELO PARA MAYOR VELOCIDAD
            var taskDocentes = Http.GetFromJsonAsync<List<Docente>>("api/Docentes");
            var taskAsignaturas = Http.GetFromJsonAsync<List<Asignatura>>("api/Asignaturas");
            var taskAulas = Http.GetFromJsonAsync<List<Aula>>("api/Aulas");
            var taskHorarios = Http.GetFromJsonAsync<List<Horario>>("api/Schedule");

            await Task.WhenAll(taskDocentes, taskAsignaturas, taskAulas, taskHorarios);

            totalDocentes = (await taskDocentes)?.Count ?? 0;
            totalAsignaturas = (await taskAsignaturas)?.Count ?? 0;
            totalAulas = (await taskAulas)?.Count ?? 0;
            totalHorarios = (await taskHorarios)?.Count ?? 0;
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"Error al cargar Dashboard: {ex.Message}");
        }
        finally
        {
            estaCargando = false;
        }
    }
}